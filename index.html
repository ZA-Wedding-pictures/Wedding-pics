<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Share your photos and videos with us!</title>
  <!-- Google font to match your palette -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --page-bg: #fafafa;
      --text-primary: #333333;
      --accent: #5C1D13;
      --accent-light: #d6a96e;
      --card-bg: #ffffff;
      --shadow-color: rgba(0,0,0,0.1);
    }

    /* ---- layout ---- */
    body {
      margin: 0;
      padding: 0 1rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--page-bg);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    h1, h2, h3 {
      margin: 0;
      font-family: 'Cormorant Garamond', serif;
      color: var(--accent);
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 4px 12px var(--shadow-color);
      padding: 2rem 2.5rem;
      max-width: 460px;
      width: 100%;
      text-align: center;
    }

    /* ---- form elements ---- */
    input[type=file],
    button {
      font: inherit;
      padding: 0.75rem 1rem;
      border: 1px solid #dddddd;
      border-radius: 8px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background: var(--accent);
      color: #fff;
      border: none;
      margin-top: 1rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover:not(:disabled) {
      background: var(--accent-light);
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    #msg {
      margin-top: 1rem;
      font-size: 0.95rem;
      min-height: 1.2em; /* keep space reserved */
    }

    /* ---- spinner ---- */
    .spinner {
      width: 24px;
      height: 24px;
      border: 4px solid var(--accent-light);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 1rem auto 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Share your photos and videos with us!</h2>
    <p>Choose as many files as you like – they’ll upload in full quality (we resize large images client‑side to speed things up).</p>

    <input type="file" id="file" accept="image/*,video/*" multiple />
    <button id="send">Upload</button>
    <div id="msg"></div>
    <div id="spinner" class="spinner hidden"></div>
  </div>

  <script>
  // Paste your Apps Script endpoint here if it changes
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwqtZqANbZ5thblNKsQdNwAdH1z5bqBKM3uMClYBeLSoxYd6CY-HuxfpYpHODHxuxur/exec';

  // ---- UI helpers ----
  document.getElementById('send').onclick = () => uploadFiles();

  function toggleUI(isUploading) {
    document.getElementById('spinner').classList.toggle('hidden', !isUploading);
    document.getElementById('send').disabled = isUploading;
    if (isUploading) {
      showMessage('Uploading…, sorry it\'s taking a while');
    }
  }
  function showMessage(text, ok = false) {
    const el = document.getElementById('msg');
    el.textContent = text;
    el.style.color = ok ? 'var(--accent)' : 'inherit';
  }

  // ---- core logic ----
  async function uploadFiles() {
    const input  = document.getElementById('file');
    const files  = Array.from(input.files);
    if (!files.length) {
      alert('Pick at least one file first!');
      return;
    }

    toggleUI(true);
    try {
      // Upload sequentially to respect Apps Script quota & avoid memory blow‑ups
      for (const file of files) {
        await uploadSingle(file);
      }
      showMessage('Thank you so much for celebrating with us. Lots of love, Adiba & Zac 🥰', true);
      input.value = '';
    } catch (err) {
      console.error(err);
      showMessage('❌ Something went wrong – please try again.');
    } finally {
      toggleUI(false);
    }
  }

  // ---- helpers ----
  function downscaleImage(file, maxDim = 2400, quality = 0.85) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        let { width: w, height: h } = img;
        if (w > h && w > maxDim) { h *= maxDim / w; w = maxDim; }
        else if (h > w && h > maxDim) { w *= maxDim / h; h = maxDim; }
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        canvas.toBlob(b => b ? resolve(b) : reject('Canvas toBlob failed'), 'image/jpeg', quality);
      };
      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });
  }

  function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  async function uploadSingle(file) {
    let blob = file;
    let filename = file.name;
    let mimetype = file.type || 'application/octet-stream';

    // Compress images client‑side to speed up transfer; skip videos
    if (file.type.startsWith('image/')) {
      blob = await downscaleImage(file);
      filename = filename.replace(/\.[^/.]+$/, '') + '_web.jpg';
      mimetype = 'image/jpeg';
    }

    const b64 = await blobToBase64(blob);
    const body = new URLSearchParams({
      data: b64,
      filename,
      mimetype
    });
    const res = await fetch(ENDPOINT, { method: 'POST', body });
    if (!res.ok) throw new Error(res.statusText);
  }
  </script>
</body>
</html>
